<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Nexus Connect</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            height: 100dvh;
            overflow: hidden;
            margin: 0;
        }

        .glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* The dynamic height fix for mobile browsers */
        .safe-bottom {
            padding-bottom: calc(1.2rem + env(safe-area-inset-bottom, 0px));
        }

        /* FRAME FLEXIBILITY CLASSES */
        video {
            width: 100%;
            height: 100%;
            transition: object-fit 0.3s ease;
        }

        /* Default state: Fill the screen */
        .video-cover {
            object-fit: cover;
        }

        /* Alternative state: Show full frame with bars */
        .video-contain {
            object-fit: contain;
            background-color: #000;
        }

        .mirror {
            transform: scaleX(-1);
        }

        .ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(15px);
        }

        .transition-all {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>

<body class="relative text-white">

    <div id="video-container" class="absolute inset-0 z-0 bg-slate-950 cursor-pointer">
        <video id="remote-video" autoplay playsinline
            class="video-cover w-full h-full opacity-0 transition-opacity duration-1000"></video>

        <div id="status-display" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <div
                class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center border border-blue-500/20 mb-4 animate-pulse">
                <span class="material-icons-round text-2xl text-blue-400">sync</span>
            </div>
            <p id="status-text" class="text-slate-500 text-sm font-light tracking-widest">CONNECTING...</p>
        </div>
    </div>

    <div id="connection-panel" class="absolute top-6 left-0 right-0 z-20 flex justify-center px-4 transition-all">
        <div class="glass rounded-2xl p-3 flex items-center gap-3 shadow-2xl w-full max-w-sm">
            <div class="flex-1 min-w-0 ml-2">
                <p class="text-[9px] uppercase tracking-tighter text-slate-500 font-bold">Meeting Room</p>
                <p id="meeting-url" class="text-xs font-mono text-blue-400 truncate opacity-80">Syncing...</p>
            </div>
            <button onclick="copyLink()"
                class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 p-2.5 rounded-xl transition-all active:scale-90 border border-blue-500/30">
                <span class="material-icons-round text-sm">link</span>
            </button>
        </div>
    </div>

    <div id="local-container"
        class="absolute top-24 right-4 z-10 w-24 sm:w-40 aspect-[3/4] sm:aspect-video rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-slate-900 transition-all">
        <video id="local-video" autoplay muted playsinline class="mirror video-cover"></video>
    </div>

    <div id="controls-bar"
        class="absolute bottom-0 left-0 right-0 z-20 flex justify-center safe-bottom transition-all px-4">
        <div class="glass px-4 py-3 rounded-[2.5rem] flex items-center gap-3 sm:gap-4 shadow-2xl pointer-events-auto">

            <button onclick="toggleFrameFit()"
                class="w-11 h-11 sm:w-12 sm:h-12 rounded-full bg-slate-800/50 flex items-center justify-center border border-white/5 hover:bg-slate-700">
                <span id="frame-icon" class="material-icons-round text-xl text-slate-300">aspect_ratio</span>
            </button>

            <button id="device-action" onclick="handleDeviceAction()"
                class="w-11 h-11 sm:w-12 sm:h-12 rounded-full bg-slate-800/50 flex items-center justify-center border border-white/5">
                <span id="device-icon" class="material-icons-round text-xl text-slate-300">screen_share</span>
            </button>

            <button onclick="toggleAudio()" id="btn-mic"
                class="w-11 h-11 sm:w-12 sm:h-12 rounded-full bg-slate-800/50 flex items-center justify-center border border-white/5">
                <span id="mic-icon" class="material-icons-round text-xl text-slate-300">mic</span>
            </button>

            <button onclick="toggleVideo()" id="btn-cam"
                class="w-11 h-11 sm:w-12 sm:h-12 rounded-full bg-slate-800/50 flex items-center justify-center border border-white/5">
                <span id="cam-icon" class="material-icons-round text-xl text-slate-300">videocam</span>
            </button>

            <button onclick="endCall()"
                class="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-red-500 flex items-center justify-center shadow-lg shadow-red-900/40 active:scale-95 ml-2">
                <span class="material-icons-round text-2xl">call_end</span>
            </button>
        </div>
    </div>

    <div id="toast"
        class="fixed top-24 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full shadow-2xl transform transition-all -translate-y-20 opacity-0 z-50">
        <span id="toast-msg" class="text-xs font-medium tracking-wide"></span>
    </div>

    <script>
        let peer, myStream, currentCall, isScreenSharing = false, facingMode = 'user', uiVisible = true;
        let isVideoContained = false; // Track frame flexibility state

        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const urlParams = new URLSearchParams(window.location.search);
        let roomID = urlParams.get('room');

        document.getElementById('device-icon').innerText = isMobile ? 'flip_camera_ios' : 'screen_share';

        init();

        async function init() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: true });
                document.getElementById('local-video').srcObject = myStream;
                setupPeer();
            } catch (e) {
                showToast("Please allow camera/mic access");
            }
        }

        function setupPeer() {
            peer = roomID ? new Peer(roomID) : new Peer();

            peer.on('open', (id) => {
                roomID = id;
                const link = `${window.location.origin}${window.location.pathname}?room=${id}`;
                document.getElementById('meeting-url').innerText = link;
                window.history.replaceState({}, '', `?room=${id}`);
                document.getElementById('status-text').innerText = "WAITING FOR PARTNER";
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    peer = new Peer();
                    peer.on('open', () => startCall(roomID));
                }
            });

            peer.on('call', (call) => {
                currentCall = call;
                call.answer(myStream);
                handleCall(call);
            });
        }

        function startCall(targetId) {
            const call = peer.call(targetId, myStream);
            currentCall = call;
            handleCall(call);
        }

        function handleCall(call) {
            document.getElementById('connection-panel').classList.add('opacity-0', 'pointer-events-none');
            call.on('stream', (stream) => {
                document.getElementById('status-display').classList.add('hidden');
                const remote = document.getElementById('remote-video');
                remote.srcObject = stream;
                remote.classList.remove('opacity-0');
            });
            call.on('close', () => window.location.reload());
        }

        /**
         * FRAME FLEXIBILITY TOGGLE
         * Swaps between filling the screen and showing the original frame
         */
        function toggleFrameFit() {
            isVideoContained = !isVideoContained;
            const remoteVideo = document.getElementById('remote-video');
            const icon = document.getElementById('frame-icon');

            if (isVideoContained) {
                remoteVideo.classList.replace('video-cover', 'video-contain');
                icon.innerText = 'fullscreen'; // Icon suggesting "back to full screen"
                showToast("Frame: Fit to screen");
            } else {
                remoteVideo.classList.replace('video-contain', 'video-cover');
                icon.innerText = 'aspect_ratio'; // Icon suggesting "back to original"
                showToast("Frame: Fill screen");
            }
        }

        // CONTROL HANDLERS
        function handleDeviceAction() {
            if (isMobile) {
                facingMode = facingMode === 'user' ? 'environment' : 'user';
                updateStream();
            } else {
                toggleScreenShare();
            }
        }

        async function updateStream() {
            const videoTrack = myStream.getVideoTracks()[0];
            videoTrack.stop();
            const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: true });
            const newVideoTrack = newStream.getVideoTracks()[0];
            myStream.removeTrack(videoTrack);
            myStream.addTrack(newVideoTrack);
            document.getElementById('local-video').srcObject = myStream;
            document.getElementById('local-video').classList.toggle('mirror', facingMode === 'user');
            if (currentCall) {
                const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                sender.replaceTrack(newVideoTrack);
            }
        }

        async function toggleScreenShare() {
            if (isScreenSharing) {
                updateStream();
                isScreenSharing = false;
                document.getElementById('device-action').classList.remove('bg-blue-500');
            } else {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    const sender = currentCall?.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(screenTrack);
                    document.getElementById('local-video').srcObject = screenStream;
                    isScreenSharing = true;
                    document.getElementById('device-action').classList.add('bg-blue-500');
                    screenTrack.onended = () => toggleScreenShare();
                } catch (e) { }
            }
        }

        function toggleAudio() {
            const track = myStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('mic-icon').innerText = track.enabled ? 'mic' : 'mic_off';
            document.getElementById('btn-mic').classList.toggle('bg-white', !track.enabled);
            document.getElementById('mic-icon').classList.toggle('text-slate-900', !track.enabled);
        }

        function toggleVideo() {
            const track = myStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('cam-icon').innerText = track.enabled ? 'videocam' : 'videocam_off';
            document.getElementById('btn-cam').classList.toggle('bg-white', !track.enabled);
            document.getElementById('cam-icon').classList.toggle('text-slate-900', !track.enabled);
        }

        function endCall() {
            window.location.href = window.location.pathname;
        }

        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('meeting-url').innerText);
            showToast("Meeting Link Copied");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg.toUpperCase();
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('-translate-y-20', 'opacity-0'), 2500);
        }

        document.getElementById('video-container').addEventListener('click', () => {
            uiVisible = !uiVisible;
            document.getElementById('controls-bar').classList.toggle('ui-hidden', !uiVisible);
            document.getElementById('local-container').classList.toggle('ui-hidden', !uiVisible);
            document.getElementById('connection-panel').classList.toggle('ui-hidden', !uiVisible);
        });
    </script>
</body>

</html>