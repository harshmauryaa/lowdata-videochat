<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus | Instant Connect</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            overflow: hidden;
        }

        .glass {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ui-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .mirror {
            transform: scaleX(-1);
        }

        .btn-icon {
            transition: all 0.2s;
        }

        .btn-icon:active {
            transform: scale(0.9);
        }
    </style>
</head>

<body class="h-screen w-screen relative text-white">

    <div id="video-container" class="absolute inset-0 z-0 bg-slate-950 cursor-pointer">
        <video id="remote-video" autoplay playsinline
            class="w-full h-full opacity-0 transition-opacity duration-1000"></video>

        <div id="status-display" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-500 rounded-full blur-3xl opacity-20 animate-pulse-slow"></div>
                <div
                    class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/10 mb-6">
                    <span class="material-icons-round text-4xl text-blue-400">group_add</span>
                </div>
            </div>
            <h2 id="status-text" class="text-xl font-light tracking-wide text-slate-300 px-6 text-center">Ready to start
                a meeting</h2>
        </div>
    </div>

    <div id="connection-panel"
        class="absolute top-6 left-0 right-0 z-20 flex justify-center px-4 transition-all duration-500">
        <div class="glass rounded-2xl p-3 flex flex-col sm:flex-row items-center gap-4 shadow-2xl max-w-lg w-full">
            <div class="flex-1 min-w-0">
                <p class="text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1">Meeting Link</p>
                <p id="meeting-url" class="text-sm font-mono text-blue-400 truncate opacity-80">Generating link...</p>
            </div>
            <button onclick="copyMeetingLink()"
                class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl text-sm font-medium flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900/40">
                <span class="material-icons-round text-lg">content_copy</span>
                <span>Copy Link</span>
            </button>
        </div>
    </div>

    <div id="controls-bar"
        class="absolute bottom-6 left-0 right-0 z-20 flex justify-center items-end px-4 pointer-events-none transition-all duration-300">
        <div
            class="glass px-4 py-3 rounded-full flex items-center gap-3 sm:gap-6 shadow-2xl pointer-events-auto max-w-[95vw] justify-center">

            <button onclick="toggleScreenShare()" id="btn-screen"
                class="hidden sm:flex btn-icon w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-slate-700/50 hover:bg-slate-600 text-white items-center justify-center border border-white/10"
                title="Share Screen">
                <span class="material-icons-round text-xl">screen_share</span>
            </button>

            <button onclick="flipCamera()" id="btn-flip"
                class="sm:hidden flex btn-icon w-12 h-12 rounded-full bg-slate-700/50 hover:bg-slate-600 text-white items-center justify-center border border-white/10"
                title="Flip Camera">
                <span class="material-icons-round text-xl">flip_camera_ios</span>
            </button>

            <button onclick="toggleAudio()" id="btn-mic"
                class="btn-icon w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-slate-700/50 hover:bg-slate-600 text-white flex items-center justify-center border border-white/10">
                <span id="mic-icon" class="material-icons-round text-xl">mic</span>
            </button>

            <button onclick="toggleVideo()" id="btn-cam"
                class="btn-icon w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-slate-700/50 hover:bg-slate-600 text-white flex items-center justify-center border border-white/10">
                <span id="cam-icon" class="material-icons-round text-xl">videocam</span>
            </button>

            <button onclick="endCall()"
                class="btn-icon w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow-lg shadow-red-500/30">
                <span class="material-icons-round text-xl">call_end</span>
            </button>
        </div>
    </div>

    <div id="local-container"
        class="absolute bottom-24 right-4 z-30 w-28 sm:w-48 aspect-[3/4] sm:aspect-video rounded-xl overflow-hidden shadow-2xl border-2 border-white/20 bg-slate-800 transition-all duration-500">
        <video id="local-video" autoplay muted playsinline class="mirror"></video>
    </div>

    <div id="toast"
        class="fixed top-24 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full shadow-2xl transform transition-all duration-300 translate-y-[-150%] opacity-0 z-50 flex items-center gap-3">
        <span class="material-icons-round text-blue-400 text-lg">info</span>
        <span id="toast-msg" class="text-sm font-medium">Notification</span>
    </div>

    <script>
        const peer = new Peer();
        let myStream, currentCall, isScreenSharing = false, currentFacingMode = 'user', uiVisible = true;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Elements
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const statusDisplay = document.getElementById('status-display');
        const statusText = document.getElementById('status-text');
        const connectionPanel = document.getElementById('connection-panel');
        const controlsBar = document.getElementById('controls-bar');
        const localContainer = document.getElementById('local-container');

        // URL Room Logic
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room');

        peer.on('open', (id) => {
            const meetingURL = `${window.location.origin}${window.location.pathname}?room=${id}`;
            document.getElementById('meeting-url').innerText = meetingURL;

            if (roomID) {
                statusText.innerText = "Joining meeting...";
                showToast("Auto-joining call...");
                setTimeout(() => startCall(roomID), 1000); // Small delay to ensure camera is ready
            }
        });

        async function startCamera(facingMode = 'user') {
            try {
                if (myStream) myStream.getTracks().forEach(track => track.stop());
                myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: true });
                localVideo.srcObject = myStream;
                localVideo.classList.toggle('mirror', facingMode === 'user');
                if (currentCall) replaceSenderTrack(myStream.getVideoTracks()[0]);
            } catch (err) {
                showToast("Camera access denied");
            }
        }

        // Connection Handling
        peer.on('call', (call) => {
            currentCall = call;
            call.answer(myStream);
            setupCallListeners(call);
        });

        function startCall(targetId) {
            const call = peer.call(targetId, myStream);
            currentCall = call;
            setupCallListeners(call);
        }

        function setupCallListeners(call) {
            connectionPanel.classList.add('hidden'); // Hide invite link when connected
            call.on('stream', (remoteStream) => {
                statusDisplay.classList.add('hidden');
                remoteVideo.srcObject = remoteStream;
                remoteVideo.classList.remove('opacity-0');
            });
            call.on('close', endCall);
        }

        // UI Toggles
        document.getElementById('video-container').addEventListener('click', () => {
            uiVisible = !uiVisible;
            [controlsBar, localContainer].forEach(el => el.classList.toggle('ui-hidden', !uiVisible));
        });

        // Controls
        async function toggleScreenShare() {
            if (isMobile) return;
            const btn = document.getElementById('btn-screen');
            if (!isScreenSharing) {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    replaceSenderTrack(screenTrack);
                    localVideo.srcObject = screenStream;
                    localVideo.classList.remove('mirror');
                    screenTrack.onended = () => toggleScreenShare();
                    isScreenSharing = true;
                    btn.classList.add('text-blue-400', 'bg-white/20');
                } catch (e) { }
            } else {
                await startCamera(currentFacingMode);
                isScreenSharing = false;
                btn.classList.remove('text-blue-400', 'bg-white/20');
            }
        }

        async function flipCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await startCamera(currentFacingMode);
        }

        function toggleAudio() {
            const track = myStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('mic-icon').innerText = track.enabled ? 'mic' : 'mic_off';
            document.getElementById('btn-mic').classList.toggle('bg-white', !track.enabled);
            document.getElementById('btn-mic').classList.toggle('text-slate-900', !track.enabled);
        }

        function toggleVideo() {
            const track = myStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('cam-icon').innerText = track.enabled ? 'videocam' : 'videocam_off';
            document.getElementById('btn-cam').classList.toggle('bg-white', !track.enabled);
            document.getElementById('btn-cam').classList.toggle('text-slate-900', !track.enabled);
        }

        function replaceSenderTrack(newTrack) {
            if (currentCall?.peerConnection) {
                const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(newTrack);
            }
        }

        function endCall() {
            window.location.href = window.location.pathname; // Redirect to clean URL
        }

        function copyMeetingLink() {
            navigator.clipboard.writeText(document.getElementById('meeting-url').innerText);
            showToast("Meeting link copied!");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('translate-y-[-150%]', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-[-150%]', 'opacity-0'), 3000);
        }

        // Init
        startCamera();
        if (isMobile) {
            document.getElementById('btn-screen').remove();
        } else {
            document.getElementById('btn-flip').remove();
        }
    </script>
</body>

</html>